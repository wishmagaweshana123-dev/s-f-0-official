<!DOCTYPE html><!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SF0</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --blue:#007aff; --bg:#f5f7fb; --card:#ffffff; --muted:#6b7280; --danger:#ff3b30; --nav-active:#e6f0ff;
    --glass: rgba(255,255,255,0.85);
    --text: #0b1220;
    --liked-color: #007aff; /* Primary color for liked state */
  }
  [data-theme="dark"]{
    --blue:#4ea1ff; --bg:#0b1220; --card:#07101a; --muted:#9aa6b2; --nav-active:rgba(78,161,255,0.09); --glass: rgba(255,255,255,0.02);
    --text: #ffffff;
    --liked-color: #4ea1ff;
    /* Keeping dark theme logic for compatibility, but the toggle button is removed */
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
  header{padding:22px 16px;text-align:center;color:var(--blue);font-weight:700;font-size:22px}
  .container{max-width:1200px;margin:0 auto;padding:0 14px}
  .app {display:none}
  .layout{display:flex;gap:18px;padding-bottom:40px}
  /* Sidebar */
  .sidebar{
    width:240px; background:var(--card); border-radius:12px; padding:12px; box-shadow:0 8px 30px rgba(2,6,23,0.06);
    height:calc(100vh - 120px); position:sticky; top:72px; overflow:auto; transition:transform .28s ease, width .22s ease;
  }
  .brand{display:flex;align-items:center;gap:12px;padding:10px 6px;margin-bottom:6px}
  .brand h3{margin:0;font-size:16px}
  .nav{margin-top:8px;display:flex;flex-direction:column;gap:6px}
  .nav-item{
    display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;cursor:pointer;transition:all .18s ease;
    color:inherit;text-decoration:none;user-select:none;
  }
  .nav-item .icon{font-size:18px}
  .nav-item .label{font-weight:600}
  .nav-item:hover{transform:translateX(6px);background:rgba(0,0,0,0.03)}
  .nav-item.active{background:var(--nav-active);color:var(--blue);box-shadow:0 6px 18px rgba(2,6,23,0.04);transform:none}

  /* NEW: Logout Button in Nav (red color, no icon needed) */
  .nav-item.logout {
    color: var(--danger);
    margin-top: auto; /* Push to the bottom */
    font-weight: 700;
  }
  .nav-item.logout:hover {
    background: rgba(255, 59, 48, 0.08); /* Light red hover */
  }
  .nav-item.logout .label {
      font-weight: 700;
  }

  /* header bar */
  .header-bar{display:flex;justify-content:space-between;align-items:center;padding:12px 0}
  #menuToggle{display:none;background:transparent;border:0;font-size:22px;padding:8px 10px;cursor:pointer;border-radius:8px}
  .top-right{display:flex;align-items:center;gap:8px}
  .small-btn{padding:8px 10px;border-radius:8px;border:0;cursor:pointer;background:#eef2ff}
  .btn{padding:10px 12px;border-radius:10px;border:0;background:var(--blue);color:#fff;cursor:pointer}
  .muted{color:var(--muted);font-size:13px}
  .content{flex:1}
  .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.04);margin-bottom:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,textarea,select,button{font-family:inherit;font-size:15px}
  input,textarea,select{padding:10px;border-radius:8px;border:1px solid #e6e9f0;background:var(--card);color:var(--text)}
  textarea{min-height:100px;resize:vertical}
  .error{color:var(--danger);font-size:13px;margin-top:6px}
  .center-card{max-width:520px;margin:36px auto;padding:22px;background:var(--card);border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,0.06)}
  footer{padding:16px;text-align:center;color:var(--muted)}
  /* media */
  @media (max-width:900px){
    .layout{flex-direction:column}
    .sidebar{position:fixed;left:0;top:72px;height:calc(100vh - 72px);transform:translateX(-100%);z-index:1200;width:280px;box-shadow:8px 0 30px rgba(2,6,23,0.12)}
    .sidebar.open{transform:translateX(0)}
    #menuToggle{display:inline-block}
    .overlay{display:none}
    .overlay.open{display:block;position:fixed;inset:0;background:rgba(3,10,20,0.55);z-index:1100}
  }

  /* min-component styles */
  .inline-muted{color:var(--muted);font-size:13px}
  .post, .video, .positive, .complaint, .admin-row{border-radius:10px;padding:12px;margin-bottom:12px;background:var(--card);box-shadow:0 6px 18px rgba(2,6,23,0.04)}
  .controls{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
  .count{font-weight:600;margin-left:6px}
  .comment-box{margin-top:8px}
  .comment{padding:8px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg,rgba(0,0,0,0.02),transparent)}
  .small-muted{font-size:12px;color:var(--muted)}
  .admin-panel{display:none;margin-bottom:12px}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  .tag{padding:6px 8px;border-radius:8px;background:rgba(0,0,0,0.04);font-size:12px}
  /* edit inline */
  .edit-form input, .edit-form textarea{width:100%;margin-bottom:8px}
  .edit-controls{display:flex;gap:8px;justify-content:flex-end}
  /* subtle animations */
  .fade-in{animation:fadeIn .28s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

  /* NEW: Video Title Link */
  .video-title-link {
    color: var(--blue);
    text-decoration: none;
    font-size: 1.1em;
    display: block;
    margin-bottom: 8px;
    transition: color 0.1s ease;
  }
  .video-title-link:hover {
    color: var(--danger);
  }

  /* NEW: Like/Dislike Animation/Identification */
  .like-btn.liked {
      background-color: var(--liked-color);
      color: var(--card); /* white or card color */
      animation: bounce 0.3s ease-in-out;
  }
  @keyframes bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
  }

  /* NEW: Admin Reply Styles */
  .admin-reply-box {
    margin-top: 12px;
    padding: 12px;
    border-radius: 8px;
    background: var(--nav-active);
  }
  .user-reply-history {
    margin-top: 16px;
    border-top: 1px solid rgba(0,0,0,0.1);
    padding-top: 16px;
  }
  
  /* NEW: Social Media Link Icons */
  .social-links a {
      font-size: 24px;
      margin-right: 15px;
      color: var(--muted);
      transition: color 0.2s ease;
      text-decoration: none;
  }
  .social-links a:hover {
      color: var(--blue);
  }
</style>
</head>
<body>
<header>HY! WELCOME TO SF0</header>

<div id="authWrap" class="container">
  <div id="authCards" class="center-card fade-in" aria-live="polite">
    <div id="loginView">
      <h2 style="margin:0 0 8px 0">Login</h2>
      <input id="loginEmail" type="email" placeholder="Email" />
      <input id="loginPass" type="password" placeholder="Password" style="margin-top:8px" />
      <div class="row" style="margin-top:10px">
        <button id="loginBtn" class="btn">Login</button>
        <button id="showSignup" class="small-btn">Create account</button>
        <button id="forgotBtn" class="small-btn" style="background:#fff;border:1px solid #e6e9f0">Forgot password?</button>
      </div>
      <div id="loginError" class="error"></div>
      <div style="margin-top:10px" class="inline-muted">Email must be verified to login. Check your Spam folder.</div>
    </div>

    <div id="signupView" style="display:none">
      <h2 style="margin:0 0 8px 0">Create account</h2>
      <input id="signupEmail" type="email" placeholder="Email" />
      <input id="signupPass" type="password" placeholder="Password (6+ chars)" style="margin-top:8px" />
      <div class="row" style="margin-top:10px">
        <button id="signupBtn" class="btn">Sign up</button>
        <button id="showLogin" class="small-btn">Back to login</button>
      </div>
      <div id="signupError" class="error"></div>
      <div style="margin-top:10px" class="inline-muted">After signup, check your email and verify. You cannot login until verified.</div>
    </div>

    <div id="resetView" style="display:none">
      <h2 style="margin:0 0 8px 0">Reset password</h2>
      <input id="resetEmail" type="email" placeholder="Enter your account email" />
      <div class="row" style="margin-top:10px">
        <button id="sendReset" class="btn">Send reset link</button>
        <button id="backToLogin" class="small-btn">Back</button>
      </div>
      <div id="resetMsg" class="inline-muted" style="margin-top:8px"></div>
      <div id="resetError" class="error"></div>
    </div>
  </div>
</div>

<div id="app" class="app container" style="display:none">
  <div class="header-bar">
    <div style="display:flex;align-items:center;gap:12px">
      <button id="menuToggle" aria-label="Open menu">‚ò∞</button>
      <div style="font-weight:700;color:var(--blue)">SF0 Dashboard</div>
    </div>

    <div class="top-right">
      <div class="inline-muted" id="currentEmail">Not signed</div>
      </div>
  </div>

  <div class="layout">
    <nav class="sidebar" id="sidebar" aria-label="Main navigation">
      <div class="brand">
        <div>
          <h3 style="margin:0">SF0</h3>
          <div class="small-muted">Role Based Site</div>
        </div>
      </div>

      <div class="nav" id="mainNav">
        <div class="nav-item" data-target="home"><div class="icon">üè†</div><div class="label">Home</div></div>
        <div class="nav-item" data-target="videos"><div class="icon">üé•</div><div class="label">Videos</div></div>
        <div class="nav-item" data-target="posts"><div class="icon">üìù</div><div class="label">Posts</div></div>
        <div class="nav-item" data-target="positives"><div class="icon">üåü</div><div class="label">Positive Thinking</div></div>
        <div class="nav-item" data-target="growth"><div class="icon">üìà</div><div class="label">Growth</div></div>
        <div class="nav-item" data-target="complaints"><div class="icon">‚úâÔ∏è</div><div class="label">Complaints</div></div>
        <div class="nav-item" data-target="admins"><div class="icon">üõ†Ô∏è</div><div class="label">Manage Admins</div></div>
        <div class="nav-item" data-target="about"><div class="icon">‚ÑπÔ∏è</div><div class="label">About</div></div>
        <div class="nav-item" data-target="contact"><div class="icon">üìû</div><div class="label">Contact</div></div>
        
        <div class="nav-item logout" id="logoutBtn" style="margin-top:20px; color:var(--danger); font-weight:700;">
            <div class="label">Logout</div>
        </div>
      </div>
    </nav>

    <div id="overlay" class="overlay" aria-hidden="true"></div>

    <main class="content">
      <section id="home" class="card" style="display:block">
        <div class="flex-between">
          <h3 style="margin:0">Welcome</h3>
          <div class="tag" id="roleTag">‚Äî</div>
        </div>
        <p class="muted">Welcome to SF0. Use the sidebar to navigate.</p>
      </section>

      <section id="videos" class="card" style="display:none">
        <div class="flex-between">
          <h3 style="margin:0">Videos</h3>
          <div class="small-muted">Admins can upload & edit</div>
        </div>

        <div id="videoAdmin" class="admin-panel card" style="display:none">
          <h4 style="margin:0 0 8px 0">Upload video (admin)</h4>
          <input id="videoTitle" placeholder="Title" />
          <input id="videoUrl" placeholder="YouTube Link (e.g. https://www.youtube.com/watch?v=...)" style="margin-top:8px"/>
          <div class="row" style="margin-top:8px">
            <button id="uploadVideo" class="btn">Upload</button>
            <button id="clearVideo" class="small-btn">Clear</button>
          </div>
        </div>

        <div id="videoList" style="margin-top:12px"></div>
      </section>

      <section id="posts" class="card" style="display:none">
        <div class="flex-between">
          <h3 style="margin:0">Posts</h3>
          <div class="small-muted">Admins can create posts</div>
        </div>

        <div id="postAdmin" class="admin-panel card" style="display:none">
          <h4 style="margin:0 0 8px 0">Create post (admin)</h4>
          <input id="postTitle" placeholder="Title" />
          <textarea id="postText" placeholder="Post body" style="margin-top:8px"></textarea>
          <div class="row" style="margin-top:8px">
            <button id="uploadPost" class="btn">Publish</button>
            <button id="clearPost" class="small-btn">Clear</button>
          </div>
        </div>

        <div id="postList" style="margin-top:12px"></div>
      </section>

      <section id="positives" class="card" style="display:none">
        <h3 style="margin:0 0 8px 0">Positive Thinking</h3>
        <div id="positiveList"></div>
      </section>
      
      <section id="growth" class="card" style="display:none">
          <h3 style="margin:0 0 8px 0">Growth Analytics</h3>
          <p class="muted">User growth over time is visible here.</p>
          <div id="growthGraph" style="padding:16px; border:1px solid #e6e9f0; border-radius:10px; min-height:200px; display:flex; justify-content:center; align-items:center;">
              <p class="muted">A normal graph illustrating user growth will be rendered here.</p>
          </div>
      </section>

      <section id="complaints" class="card" style="display:none">
        <h3 style="margin:0 0 8px 0">Complaint Center</h3>

        <div class="card" style="margin-bottom:16px;">
            <h4 style="margin:0 0 8px 0">Submit a Private Complaint</h4>
            <textarea id="complaintText" placeholder="Write your private complaint here..."></textarea>
            <div class="row" style="margin-top:8px">
                <button id="sendComplaint" class="btn">Send complaint (private)</button>
                <div id="complaintMsg" class="inline-muted" style="align-self:center;margin-left:8px"></div>
            </div>
            <div class="muted" style="margin-top:8px">Your message will not be visible to other users.</div>
        </div>
        
        <div id="userComplaintHistory" class="user-reply-history">
            <h4 style="margin:0 0 8px 0">Your Complaint History</h4>
            <div id="userComplaintsList"></div>
        </div>

        <div id="complaintAdmin" class="admin-panel card" style="display:none; margin-top:16px">
            <h4 style="margin:0 0 8px 0">All Complaints (Admin View)</h4>
            <div id="complaintsList"></div>
        </div>
      </section>

      <section id="admins" class="card" style="display:none">
        <h3 style="margin:0 0 8px 0">Manage Admins (Owner only)</h3>
        <input id="adminEmailInput" placeholder="User email (to promote/demote)" />
        <div class="row" style="margin-top:8px">
          <button id="promoteBtn" class="btn">Promote to Admin</button>
          <button id="demoteBtn" class="small-btn" style="background:#fee">Demote to User</button>
        </div>
        <div id="adminsList" style="margin-top:12px"></div>
      </section>

      <section id="about" class="card" style="display:none">
        <h3 style="margin:0 0 8px 0">About Us</h3>
        
        <div id="aboutAdmin" class="admin-panel card" style="margin-bottom:16px;">
            <h4 style="margin:0 0 8px 0">Edit About Content (Admin)</h4>
            <textarea id="aboutTextarea" placeholder="Write the main 'About Us' content here..."></textarea>
            <div class="row" style="margin-top:8px">
                <button id="saveAboutBtn" class="btn">Save Content</button>
                <button id="clearAboutBtn" class="small-btn" style="background:#fee">Clear Content</button>
                <div id="aboutMsg" class="inline-muted" style="align-self:center;margin-left:8px"></div>
            </div>
        </div>
        
        <div id="aboutContent" style="white-space: pre-wrap;">
            <p class="muted">Loading content...</p>
        </div>
      </section>

      <section id="contact" class="card" style="display:none">
        <h3 style="margin:0 0 8px 0">Contact & Social Profiles</h3>
        
        <div id="socialAdmin" class="admin-panel card" style="margin-bottom:16px;">
            <h4 style="margin:0 0 8px 0">Set Social Media Links (Admin)</h4>
            <input id="socialFb" placeholder="Facebook URL (e.g. https://facebook.com/user)" />
            <input id="socialTw" placeholder="Twitter URL (e.g. https://twitter.com/user)" style="margin-top:8px" />
            <input id="socialLi" placeholder="LinkedIn URL (e.g. https://linkedin.com/in/user)" style="margin-top:8px" />
            <div class="row" style="margin-top:8px">
                <button id="setSocialsBtn" class="btn">Save Socials</button>
                <div id="socialMsg" class="inline-muted" style="align-self:center;margin-left:8px"></div>
            </div>
        </div>

        <div class="social-links" id="socialLinksDisplay">
            <p class="muted">Follow us on social media:</p>
            </div>

        <div class="muted" style="margin-top:16px">For complaints, please use the Complaints section in the sidebar.</div>
      </section>

    </main>
  </div>

  <footer>SF0 ‚Ä¢ Official</footer>
</div>

<script type="module">
/*
  Single-file app JS
  - Uses Firebase JS SDK v11 (compat modular imports)
*/
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, set, push, get, update, remove, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendEmailVerification, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

// ===== CONFIG =====
const firebaseConfig = {
  apiKey: "AIzaSyCkiB65lvUh04SbfXMfKNjx0GQwAKCcwTY",
  authDomain: "sf0-yt.firebaseapp.com",
  databaseURL: "https://sf0-yt-default-rtdb.firebaseio.com/",
  projectId: "sf0-yt",
  storageBucket: "sf0-yt.firebasestorage.app",
  messagingSenderId: "466855199003",
  appId: "1:466855199003:web:c42db7397a9cd3a37f13be"
};
// Owner (hardcoded)
const OWNER_EMAIL = "chanukamindiw2006@gmail.com";
// ===================

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

/* ----------------- Helper DOM ----------------- */
const authWrap = document.getElementById('authWrap');
const appWrap = document.getElementById('app');
const currentEmail = document.getElementById('currentEmail');
const roleTag = document.getElementById('roleTag');

const showLogin = id => {
  document.getElementById('loginView').style.display = id === 'login' ? 'block' : 'none';
  document.getElementById('signupView').style.display = id === 'signup' ? 'block' : 'none';
  document.getElementById('resetView').style.display = id === 'reset' ? 'block' : 'none';
};

/* ----------------- Auth UI wiring ----------------- */
document.getElementById('showSignup').onclick = ()=> showLogin('signup');
document.getElementById('showLogin').onclick = ()=> showLogin('login');
document.getElementById('forgotBtn').onclick = ()=> showLogin('reset');
document.getElementById('backToLogin').onclick = ()=> showLogin('login');

/* Signup */
document.getElementById('signupBtn').addEventListener('click', async ()=>{
  const email = document.getElementById('signupEmail').value.trim();
  const pass = document.getElementById('signupPass').value.trim();
  document.getElementById('signupError').textContent = '';
  if(!email || pass.length < 6){ document.getElementById('signupError').textContent = 'Enter valid email & password (6+ chars)'; return; }
  try{
    const uc = await createUserWithEmailAndPassword(auth, email, pass);
    await sendEmailVerification(uc.user);
    // save user in DB with role user (owner if matches)
    const role = (email === OWNER_EMAIL) ? 'owner' : 'user';
    await set(ref(db, 'users/' + uc.user.uid), { email, role });
    // force sign-out so the new user cannot stay logged in before verifying email
    await signOut(auth);
    alert('Account created. Please verify your email (check Spam). You must verify before login.');
    showLogin('login');
  }catch(e){
    document.getElementById('signupError').textContent = e.message;
  }
});

/* Login */
document.getElementById('loginBtn').addEventListener('click', async ()=>{
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPass').value.trim();
  document.getElementById('loginError').textContent = '';
  if(!email || !pass){ document.getElementById('loginError').textContent = 'Enter email & password'; return; }
  try{
    const uc = await signInWithEmailAndPassword(auth, email, pass);
    if(!uc.user.emailVerified){ await signOut(auth); alert('Please verify your email before logging in.'); return; }
  }catch(e){
    document.getElementById('loginError').textContent = e.message;
  }
});

/* Reset password */
document.getElementById('sendReset').addEventListener('click', async ()=>{
  const email = document.getElementById('resetEmail').value.trim();
  document.getElementById('resetError').textContent = ''; document.getElementById('resetMsg').textContent = '';
  if(!email){ document.getElementById('resetError').textContent = 'Enter your email'; return; }
  try{
    await sendPasswordResetEmail(auth, email);
    document.getElementById('resetMsg').textContent = 'Password reset email sent. Check your inbox (and Spam).';
  }catch(e){ document.getElementById('resetError').textContent = e.message; }
});

/* Logout (Now a nav-item) */
document.getElementById('logoutBtn').addEventListener('click', ()=> signOut(auth));

/* ----------------- Theme toggle (removed from JS as requested) ----------------- */
// Set initial theme to light since toggle is gone
const savedTheme = localStorage.getItem('sf0_theme') || 'light';
document.documentElement.setAttribute('data-theme', savedTheme === 'dark' ? 'dark' : 'light');


/* ----------------- Navigation ----------------- */
const navItems = Array.from(document.querySelectorAll('.nav-item'));
function setActiveNav(target){
  navItems.forEach(it => {
    if(it.dataset.target === target) it.classList.add('active'); else it.classList.remove('active');
  });
}
function showSection(id){
  document.querySelectorAll('main section').forEach(s => s.style.display = 'none');
  const el = document.getElementById(id);
  if(el) el.style.display = 'block';
  setActiveNav(id);
  // close mobile sidebar if open
  if(window.innerWidth <= 900) closeSidebar();
}
navItems.forEach(it => {
    // Check if the item has a data-target attribute (i.e. is a regular navigation link)
    if (it.dataset.target) {
        it.addEventListener('click', ()=> showSection(it.dataset.target));
    }
});

/* Sidebar mobile behavior */
const menuToggle = document.getElementById('menuToggle');
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');
function openSidebar(){ sidebar.classList.add('open'); overlay.classList.add('open'); overlay.style.display='block'; overlay.onclick = closeSidebar; }
function closeSidebar(){ sidebar.classList.remove('open'); overlay.classList.remove('open'); overlay.style.display='none'; overlay.onclick = null; }
menuToggle.addEventListener('click', ()=> {
  if(sidebar.classList.contains('open')) closeSidebar(); else openSidebar();
});
window.addEventListener('resize', ()=> { if(window.innerWidth > 900) closeSidebar(); });

/* ----------------- Role helpers ----------------- */
async function getRoleForCurrentUser(){
  const u = auth.currentUser;
  if(!u) return null;
  const snap = await get(ref(db, 'users/' + u.uid));
  if(!snap.exists()) return null;
  return snap.val().role;
}

/* ----------------- Auth state handling ----------------- */
onAuthStateChanged(auth, async (user) => {
  if(user){
    currentEmail.textContent = user.email;
    authWrap.style.display = 'none';
    appWrap.style.display = 'block';
    // ensure user record exists
    const uRef = ref(db, 'users/' + user.uid);
    const snap = await get(uRef);
    if(!snap.exists()){
      const role = (user.email === OWNER_EMAIL) ? 'owner' : 'user';
      await set(uRef, { email: user.email, role });
    } else {
      // if owner's email and DB not owner -> update
      if(user.email === OWNER_EMAIL && snap.val().role !== 'owner'){
        await update(uRef, { role: 'owner' });
      }
    }
    await refreshRoleUI();
    await renderAll();
    showSection('home');
  } else {
    authWrap.style.display = 'block';
    appWrap.style.display = 'none';
    currentEmail.textContent = '';
    showLogin('login');
  }
});

/* Update UI based on role */
async function refreshRoleUI(){
  const role = await getRoleForCurrentUser();
  roleTag.textContent = role ? role.toUpperCase() : '‚Äî';
  // show/hide admin panels
  document.querySelectorAll('.admin-panel').forEach(p => p.style.display = (role === 'admin' || role === 'owner') ? 'block' : 'none');
  // manage-admins visible only to owner
  document.getElementById('admins').style.display = (role === 'owner') ? 'block' : 'none';
  // social-admin visible only to admin/owner
  document.getElementById('socialAdmin').style.display = (role === 'admin' || role === 'owner') ? 'block' : 'none';
  // complaintAdmin visible only to admin/owner
  document.getElementById('complaintAdmin').style.display = (role === 'admin' || role === 'owner') ? 'block' : 'none';
  // aboutAdmin visible only to admin/owner
  document.getElementById('aboutAdmin').style.display = (role === 'admin' || role === 'owner') ? 'block' : 'none';
  // video/post admin panels controlled already via .admin-panel
}

/* ----------------- CONTENT CRUD: Videos, Posts, Positives ----------------- */

/* Utility helpers for safe HTML */
function esc(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function escAttr(s){ if(!s) return ''; return String(s).replace(/"/g,'&quot;'); }

/* VIDEOS - UPDATED to use clickable title and original URL */
document.getElementById('uploadVideo').addEventListener('click', async ()=>{
  const title = document.getElementById('videoTitle').value.trim();
  const urlInput = document.getElementById('videoUrl').value.trim(); // Changed ID to videoUrl
  if(!title || !urlInput){ alert('Title and YouTube URL required'); return; }

  // Simple check for YouTube URL structure
  if(!urlInput.includes('youtube.com/') && !urlInput.includes('youtu.be/')) {
      alert('Please provide a valid YouTube URL.');
      return;
  }

  const role = await getRoleForCurrentUser();
  if(role === 'admin' || role === 'owner'){
    // Store the raw URL as requested
    await push(ref(db, 'videos'), { title, url: urlInput, uploader: auth.currentUser.uid, createdAt: Date.now() });
    document.getElementById('videoTitle').value = ''; document.getElementById('videoUrl').value = '';
    await renderVideos();
  } else alert('Only admins/owner can upload videos');
});

// UPDATED renderVideos function
async function renderVideos(){
  const listEl = document.getElementById('videoList'); listEl.innerHTML = '';
  const snap = await get(ref(db, 'videos'));
  if(!snap.exists()){ listEl.innerHTML = '<div class="muted">No videos yet</div>'; return; }
  const role = await getRoleForCurrentUser();

  snap.forEach(child => {
    const v = child.val();
    const k = child.key;
    const isLiked = document.querySelector(`#vlikes-btn-${k}`)?.classList.contains('liked') || false;

    const wrapper = document.createElement('div'); wrapper.className = 'video fade-in';
    wrapper.innerHTML = `
      <div class="flex-between">
        <div>
          <a href="${escAttr(v.url)}" target="_blank" class="video-title-link">
            <strong>${esc(v.title)}</strong>
          </a>
          <div class="small-muted">Uploaded: ${new Date(v.createdAt).toLocaleString()}</div>
        </div>
        <div>
          <span class="small-muted">üëç</span> <span class="count" id="vlikes-${k}">0</span>
        </div>
      </div>
      <div class="controls">
        <button class="small-btn like-btn" id="vlikes-btn-${k}" data-collection="videos" data-id="${k}">Like</button>
        <button class="small-btn commentToggle" data-type="video" data-id="${k}">Comments</button>
      </div>
      <div class="comment-box" id="vcomments-${k}" style="display:none"></div>
    `;

    if(role === 'admin' || role === 'owner'){
      const edit = document.createElement('button'); edit.className='small-btn'; edit.textContent='Edit';
      edit.onclick = async ()=> {
        const nt = prompt('New title', v.title); 
        const nu = prompt('New YouTube URL (e.g. watch?v=...)', v.url);
        if(nt && nu){ 
            if(!nu.includes('youtube.com/') && !nu.includes('youtu.be/')){ alert('Invalid YouTube URL for editing.'); return; }
            await update(ref(db,'videos/'+k), { title: nt, url: nu }); 
            renderVideos(); 
        }
      };
      const del = document.createElement('button'); del.className='small-btn'; del.style.background='#fee'; del.textContent='Delete';
      del.onclick = async ()=> { if(confirm('Delete this video?')){ await remove(ref(db,'videos/'+k)); renderVideos(); } };
      wrapper.querySelector('.controls').appendChild(edit); wrapper.querySelector('.controls').appendChild(del);
    }
    listEl.appendChild(wrapper);

    // Attach delegated listener for liking
    wrapper.querySelector(`#vlikes-btn-${k}`).addEventListener('click', (e)=> toggleLike(e.target.dataset.collection, e.target.dataset.id, e.target));
    wrapper.querySelector('.commentToggle').addEventListener('click', ()=> toggleComments('videos', k, 'video'));
    // render likes count & set up live update
    watchLikes('videos', k, `vlikes-${k}`, `vlikes-btn-${k}`);
  });
}

/* POSTS */
document.getElementById('uploadPost').addEventListener('click', async ()=>{
  const title = document.getElementById('postTitle').value.trim();
  const content = document.getElementById('postText').value.trim();
  if(!title || !content){ alert('Title & text required'); return; }
  const role = await getRoleForCurrentUser();
  if(role === 'admin' || role === 'owner'){
    await push(ref(db, 'posts'), { title, content, uploader: auth.currentUser.uid, createdAt: Date.now() });
    document.getElementById('postTitle').value = ''; document.getElementById('postText').value = '';
    await renderPosts();
  } else alert('Only admins/owner can upload posts');
});

async function renderPosts(){
  const listEl = document.getElementById('postList'); listEl.innerHTML = '';
  const snap = await get(ref(db, 'posts'));
  if(!snap.exists()){ listEl.innerHTML = '<div class="muted">No posts yet</div>'; return; }
  const role = await getRoleForCurrentUser();
  snap.forEach(child => {
    const p = child.val(); const k = child.key;
    const wrapper = document.createElement('div'); wrapper.className = 'post fade-in';
    wrapper.innerHTML = `
      <div class="flex-between">
        <div><strong>${esc(p.title)}</strong><div class="small-muted">Posted: ${new Date(p.createdAt).toLocaleString()}</div></div>
        <div><span class="small-muted">üëç</span> <span class="count" id="plikes-${k}">0</span></div>
      </div>
      <div style="margin-top:8px"><p>${esc(p.content)}</p></div>
      <div class="controls">
        <button class="small-btn like-btn" id="plikes-btn-${k}" data-collection="posts" data-id="${k}">Like</button>
        <button class="small-btn commentToggle" data-type="post" data-id="${k}">Comments</button>
      </div>
      <div class="comment-box" id="pcomments-${k}" style="display:none"></div>
    `;
    if(role === 'admin' || role === 'owner'){
      const edit = document.createElement('button'); edit.className='small-btn'; edit.textContent='Edit';
      edit.onclick = ()=> inlineEditPost(k, p);
      const del = document.createElement('button'); del.className='small-btn'; del.style.background='#fee'; del.textContent='Delete';
      del.onclick = async ()=> { if(confirm('Delete post?')){ await remove(ref(db,'posts/'+k)); renderPosts(); } };
      wrapper.querySelector('.controls').appendChild(edit); wrapper.querySelector('.controls').appendChild(del);
    }
    listEl.appendChild(wrapper);

    // Attach delegated listener for liking
    wrapper.querySelector(`#plikes-btn-${k}`).addEventListener('click', (e)=> toggleLike(e.target.dataset.collection, e.target.dataset.id, e.target));
    wrapper.querySelector('.commentToggle').addEventListener('click', ()=> toggleComments('posts', k, 'post'));
    watchLikes('posts', k, `plikes-${k}`, `plikes-btn-${k}`);
  });
}

/* inline edit for posts */
function inlineEditPost(key, data){
  const wrapper = document.querySelector(`#postList .post .like-btn[data-id="${key}"]`)?.closest('.post');
  // fallback: find by scanning
  const posts = document.querySelectorAll('#postList .post');
  let el = null;
  posts.forEach(p => { if(p.innerHTML.includes(`data-id="${key}"`)) el = p; });
  if(!el) { renderPosts(); return; }
  const body = el.querySelector('div:nth-child(2)'); if(body) body.style.display = 'none';
  const form = document.createElement('div'); form.className = 'edit-form card';
  form.innerHTML = `
    <input class="edit-title" value="${escAttr(data.title)}" />
    <textarea class="edit-content">${esc(data.content)}</textarea>
    <div class="edit-controls">
      <button class="btn save">Save</button>
      <button class="small-btn cancel">Cancel</button>
    </div>
  `;
  el.appendChild(form);
  form.querySelector('.cancel').onclick = ()=> { form.remove(); if(body) body.style.display='block'; };
  form.querySelector('.save').onclick = async ()=> {
    const nt = form.querySelector('.edit-title').value.trim();
    const nc = form.querySelector('.edit-content').value.trim();
    if(!nt || !nc){ alert('Title & content required'); return; }
    await update(ref(db, 'posts/' + key), { title: nt, content: nc });
    await renderPosts();
  };
}

/* POSITIVES (simple list) */
async function renderPositives(){
  const el = document.getElementById('positiveList'); el.innerHTML = '';
  const snap = await get(ref(db, 'positives'));
  if(!snap.exists()){ el.innerHTML = '<div class="muted">No positive items yet</div>'; return; }
  snap.forEach(c => {
    const v = c.val(); const k = c.key;
    const box = document.createElement('div'); box.className = 'positive fade-in';
    box.innerHTML = `<strong>${esc(v.title)}</strong><div class="small-muted">${v.text?esc(v.text):''}</div>`;
    el.appendChild(box);
  });
}

/* Growth (placeholder function) */
async function renderGrowth(){
    // A more complex function would fetch user data and render a chart library here.
    const el = document.getElementById('growth');
    if(el){
        // Ensure the placeholder is available if the section is viewed
    }
}


/* ----------------- Likes & Comments ----------------- */
/* UPDATED toggleLike to handle button visual state */
async function toggleLike(collection, id, buttonEl){
  const u = auth.currentUser; 
  if(!u){ alert('Please login to like'); return; }
  
  const likeRef = ref(db, `likes/${collection}/${id}/${u.uid}`);
  const snap = await get(likeRef);

  if(snap.exists()){
    await remove(likeRef);
    if(buttonEl) buttonEl.classList.remove('liked');
  } else {
    await set(likeRef, true);
    if(buttonEl) {
      buttonEl.classList.add('liked');
      // Force animation replay
      buttonEl.style.animation = 'none';
      void buttonEl.offsetWidth; // Trigger reflow
      buttonEl.style.animation = null; 
    }
  }
}

/* UPDATED watchLikes to handle button visual state */
function watchLikes(collection, id, countElId, btnElId){
  const counterEl = document.getElementById(countElId);
  const btnEl = document.getElementById(btnElId);
  const u = auth.currentUser;

  const likesRef = ref(db, `likes/${collection}/${id}`);
  onValue(likesRef, (snap) => {
    const likes = snap.exists() ? snap.val() : {};
    const count = Object.keys(likes).length;
    
    // 1. Update count
    if(counterEl) counterEl.textContent = count;
    
    // 2. Update button visual state if user is logged in
    if(btnEl && u) {
        if (likes[u.uid]) {
            btnEl.classList.add('liked');
        } else {
            btnEl.classList.remove('liked');
        }
    }
  }, { onlyOnce: false });
}

/* Comments: toggle comment box ‚Äî keep open when toggled */
async function toggleComments(collectionPath, itemId, type){
  const wrapperId = (type === 'video') ? `vcomments-${itemId}` : `pcomments-${itemId}`;
  const box = document.getElementById(wrapperId);
  if(!box) return;
  if(box.style.display === 'block') { box.style.display = 'none'; return; }
  box.style.display = 'block';
  // render comment UI
  box.innerHTML = `
    <div class="comment-form">
      <textarea class="new-comment" placeholder="Write a comment..." style="width:100%;min-height:64px"></textarea>
      <div class="row" style="margin-top:8px">
        <button class="btn postComment">Post comment</button>
        <div class="small-muted" style="align-self:center;margin-left:8px">Comments are visible to everyone</div>
      </div>
    </div>
    <div class="comments-list" style="margin-top:8px"></div>
  `;
  const commentsList = box.querySelector('.comments-list');
  const postBtn = box.querySelector('.postComment');
  postBtn.addEventListener('click', async ()=>{
    const txt = box.querySelector('.new-comment').value.trim();
    if(!txt){ alert('Type a comment'); return; }
    const u = auth.currentUser; if(!u){ alert('Login to comment'); return; }
    const cobj = { uid: u.uid, text: txt, email: u.email, createdAt: Date.now() };
    await push(ref(db, `comments/${collectionPath}/${itemId}`), cobj);
    box.querySelector('.new-comment').value = '';
    await renderComments(collectionPath, itemId, commentsList);
  });
  await renderComments(collectionPath, itemId, commentsList);
}

/* render comments list */
async function renderComments(collectionPath, itemId, container){
  container.innerHTML = '';
  const snap = await get(ref(db, `comments/${collectionPath}/${itemId}`));
  if(!snap.exists()){ container.innerHTML = '<div class="small-muted">No comments yet</div>'; return; }
  const role = await getRoleForCurrentUser();
  snap.forEach(c => {
    const cm = c.val(); const k = c.key;
    const div = document.createElement('div'); div.className = 'comment';
    div.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${esc(cm.email)}</strong> <span class="small-muted">${new Date(cm.createdAt).toLocaleString()}</span></div></div><div style="margin-top:6px">${esc(cm.text)}</div>`;
    // show delete button to comment owner or admins
    const u = auth.currentUser;
    if(u && (u.uid === cm.uid || role === 'admin' || role === 'owner')) {
      const del = document.createElement('button'); del.className='small-btn'; del.textContent='Delete';
      del.onclick = async ()=> { if(confirm('Delete this comment?')){ await remove(ref(db, `comments/${collectionPath}/${itemId}/${k}`)); renderComments(collectionPath,itemId,container); } };
      div.querySelector('div').appendChild(del); // Append delete button to the flex container
    }
    container.appendChild(div);
  });
}

/* ----------------- Complaints (private & reply) ----------------- */
/* Users submit complaint -> stored at complaints/{complaintId} with uid & email & seen:false */
document.getElementById('sendComplaint').addEventListener('click', async ()=>{
  const txt = document.getElementById('complaintText').value.trim();
  document.getElementById('complaintMsg').textContent = '';
  if(!txt){ document.getElementById('complaintMsg').textContent = 'Enter a message'; return; }
  const u = auth.currentUser; if(!u){ alert('Login to submit complaint'); return; }
  await push(ref(db, 'complaints'), { uid: u.uid, email: u.email, text: txt, createdAt: Date.now(), seen: false });
  document.getElementById('complaintText').value = '';
  document.getElementById('complaintMsg').textContent = 'Complaint sent (private).';
  await renderUserComplaints();
});

/* render complaints for admins (now includes reply functionality) */
async function renderComplaints(){
  const list = document.getElementById('complaintsList'); if(!list) return;
  list.innerHTML = '';
  const snap = await get(ref(db, 'complaints'));
  if(!snap.exists()){ list.innerHTML = '<div class="muted">No complaints yet</div>'; return; }
  
  snap.forEach(c => {
    const cm = c.val(); const k = c.key;
    const row = document.createElement('div'); row.className='complaint fade-in';
    row.style.display='flex'; row.style.flexDirection='column'; row.style.gap='8px';

    row.innerHTML = `
      <div style="display:flex;justify-content:space-between">
        <div>
          <strong>${esc(cm.email)}</strong> 
          <div class="small-muted">${new Date(cm.createdAt).toLocaleString()}</div>
        </div>
        <div>
          <span class="tag">${cm.seen ? 'Seen' : 'New'}</span>
        </div>
      </div>
      <div style="margin-top:0">
        <p><strong>Complaint:</strong> ${esc(cm.text)}</p>
      </div>
    `;
    
    const controls = document.createElement('div'); controls.className='row';
    const mark = document.createElement('button'); mark.className='small-btn'; mark.textContent = cm.seen ? 'Mark unread' : 'Mark seen';
    mark.onclick = async ()=> { await update(ref(db, 'complaints/' + k), { seen: !cm.seen }); renderComplaints(); };
    const del = document.createElement('button'); del.className='small-btn'; del.style.background='#fee'; del.textContent='Delete';
    del.onclick = async ()=> { if(confirm('Delete complaint?')){ await remove(ref(db,'complaints/'+k)); renderComplaints(); } };
    controls.appendChild(mark); controls.appendChild(del);
    row.appendChild(controls);

    // Reply Section
    const replyBox = document.createElement('div'); replyBox.className = 'admin-reply-box';
    if(cm.replyText){
      // Display existing reply
      replyBox.innerHTML = `
        <p><strong>Admin Reply:</strong> ${esc(cm.replyText)}</p>
        <div class="small-muted">Replied by ${esc(cm.repliedByEmail)} on ${new Date(cm.repliedAt).toLocaleString()}</div>
      `;
    } else {
      // Display reply form
      replyBox.innerHTML = `
        <textarea placeholder="Write a private reply to ${esc(cm.email)}..." class="reply-textarea" style="width:100%;min-height:60px"></textarea>
        <button class="btn send-reply-btn" style="margin-top:8px">Send Reply</button>
      `;
      replyBox.querySelector('.send-reply-btn').onclick = async () => {
        const replyText = replyBox.querySelector('.reply-textarea').value.trim();
        if(!replyText) { alert('Reply text is required'); return; }
        const u = auth.currentUser;
        await update(ref(db, 'complaints/' + k), { 
            replyText, 
            repliedAt: Date.now(), 
            repliedBy: u.uid,
            repliedByEmail: u.email,
            seen: true // Mark seen when replying
        });
        renderComplaints();
        renderUserComplaints(); // Update the user's view
      };
    }
    row.appendChild(replyBox);
    list.appendChild(row);
  });
}

/* NEW: render user's own complaints and admin replies */
async function renderUserComplaints(){
  const list = document.getElementById('userComplaintsList');
  if(!list) return;
  list.innerHTML = '';
  
  const u = auth.currentUser;
  if (!u) {
    list.innerHTML = '<div class="muted">Please log in to see your complaint history.</div>';
    return;
  }
  
  const snap = await get(ref(db, 'complaints'));
  const userComplaints = [];
  
  snap.forEach(c => {
    const cm = c.val();
    if(cm.uid === u.uid) {
      userComplaints.push({ ...cm, key: c.key });
    }
  });

  if(userComplaints.length === 0){
    list.innerHTML = '<div class="muted">You have no complaints on file.</div>';
    return;
  }
  
  userComplaints.sort((a, b) => b.createdAt - a.createdAt); // Newest first

  userComplaints.forEach(cm => {
    const row = document.createElement('div'); row.className='complaint fade-in';
    let replyHtml = '';
    if (cm.replyText) {
      replyHtml = `<div class="admin-reply-box" style="margin-top:10px;">
        <strong style="color:var(--blue)">Admin Reply:</strong>
        <p style="margin:4px 0 0 0;">${esc(cm.replyText)}</p>
        <div class="small-muted" style="margin-top:4px">Replied on ${new Date(cm.repliedAt).toLocaleString()}</div>
      </div>`;
    } else {
      replyHtml = '<div class="small-muted" style="margin-top:10px;font-weight:600">Status: Waiting for Admin Reply</div>';
    }

    row.innerHTML = `
      <div>
        <strong>Your Complaint:</strong> 
        <span class="small-muted">${new Date(cm.createdAt).toLocaleString()}</span>
      </div>
      <p style="margin:4px 0 0 0">${esc(cm.text)}</p>
      ${replyHtml}
    `;
    list.appendChild(row);
  });
}

/* ----------------- About Section (Admin Editable Text) ----------------- */

// NEW: Function to watch and display About content
function watchAbout() {
    const displayEl = document.getElementById('aboutContent');
    const textareaEl = document.getElementById('aboutTextarea');

    onValue(ref(db, 'about/content'), (snap) => {
        const content = snap.val() || '';
        
        // 1. Update public display
        if (displayEl) {
            displayEl.textContent = content || 'No "About Us" content has been set yet.';
            // Set class to muted if no content
            if (content) displayEl.classList.remove('muted'); else displayEl.classList.add('muted');
        }
        
        // 2. Update admin input field
        if (textareaEl) textareaEl.value = content;
        
    }, { onlyOnce: false });
}

// NEW: Admin action to save About content (Edit/Create)
document.getElementById('saveAboutBtn').addEventListener('click', async ()=>{
    const content = document.getElementById('aboutTextarea').value.trim();
    document.getElementById('aboutMsg').textContent = '';

    const role = await getRoleForCurrentUser();
    if(role !== 'admin' && role !== 'owner'){ 
        document.getElementById('aboutMsg').textContent = 'Only admins can edit this content.'; 
        return; 
    }
    
    // Save content to Firebase
    await set(ref(db, 'about/content'), content);
    document.getElementById('aboutMsg').textContent = 'About content saved/updated.';
});

// NEW: Admin action to clear/delete About content
document.getElementById('clearAboutBtn').addEventListener('click', async ()=>{
    const role = await getRoleForCurrentUser();
    if(role !== 'admin' && role !== 'owner'){ 
        document.getElementById('aboutMsg').textContent = 'Only admins can clear this content.'; 
        return; 
    }
    
    if (confirm('Are you sure you want to completely clear/delete the About Us content?')) {
        // Remove content from Firebase
        await remove(ref(db, 'about/content'));
        document.getElementById('aboutMsg').textContent = 'About content cleared/deleted.';
        document.getElementById('aboutTextarea').value = '';
    }
});

// Function to render About
async function renderAbout() {
    watchAbout();
}

/* ----------------- Contact & Social Profiles ----------------- */

// NEW: Admin action to set social media links
document.getElementById('setSocialsBtn').addEventListener('click', async ()=>{
    const fb = document.getElementById('socialFb').value.trim();
    const tw = document.getElementById('socialTw').value.trim();
    const li = document.getElementById('socialLi').value.trim();
    document.getElementById('socialMsg').textContent = '';

    const role = await getRoleForCurrentUser();
    if(role !== 'admin' && role !== 'owner'){ 
        document.getElementById('socialMsg').textContent = 'Only admins can set social links.'; 
        return; 
    }

    const updates = {};
    if (fb) updates.facebook = fb;
    if (tw) updates.twitter = tw;
    if (li) updates.linkedin = li;

    if (Object.keys(updates).length > 0) {
        await set(ref(db, 'socials'), updates);
        document.getElementById('socialMsg').textContent = 'Social links saved.';
        // Clear inputs after save
        document.getElementById('socialFb').value = fb; 
        document.getElementById('socialTw').value = tw;
        document.getElementById('socialLi').value = li;
    } else {
        document.getElementById('socialMsg').textContent = 'No links entered.';
    }
    
    // Ensure the display updates instantly
    await renderContact();
});

// NEW: Function to watch and display social media links
function watchSocials() {
    const displayEl = document.getElementById('socialLinksDisplay');
    const inputFb = document.getElementById('socialFb');
    const inputTw = document.getElementById('socialTw');
    const inputLi = document.getElementById('socialLi');

    onValue(ref(db, 'socials'), (snap) => {
        const socials = snap.val() || {};
        let html = '<p class="muted">Follow us on social media:</p>';
        let hasLinks = false;

        // Render display links (using Unicode characters as icon placeholders)
        if (socials.facebook) {
            html += `<a href="${escAttr(socials.facebook)}" target="_blank" title="Facebook">üìò</a>`;
            hasLinks = true;
        }
        if (socials.twitter) {
            html += `<a href="${escAttr(socials.twitter)}" target="_blank" title="Twitter">üê¶</a>`;
            hasLinks = true;
        }
        if (socials.linkedin) {
            html += `<a href="${escAttr(socials.linkedin)}" target="_blank" title="LinkedIn">üîó</a>`;
            hasLinks = true;
        }
        
        if (!hasLinks) {
             html = '<p class="muted">No social media profiles have been set yet.</p>';
        }

        displayEl.innerHTML = html;
        
        // Update admin input fields with current values when data changes (for live editing)
        if (inputFb) inputFb.value = socials.facebook || '';
        if (inputTw) inputTw.value = socials.twitter || '';
        if (inputLi) inputLi.value = socials.linkedin || '';
        
    }, { onlyOnce: false });
}

// Placeholder for renderContact
async function renderContact() {
    watchSocials();
    // No other dynamic rendering needed for the Contact section at this time
}


/* ----------------- Manage Admins (owner) ----------------- */
document.getElementById('promoteBtn').addEventListener('click', async ()=>{
  const email = document.getElementById('adminEmailInput').value.trim();
  if(!email){ alert('Enter email'); return; }
  const role = await getRoleForCurrentUser(); if(role !== 'owner'){ alert('Only owner can add admins'); return; }
  const usersSnap = await get(ref(db, 'users'));
  let foundUid = null;
  usersSnap.forEach(c => { if(c.val().email === email) foundUid = c.key; });
  if(!foundUid){ alert('User not found (they must sign up first)'); return; }
  await update(ref(db, 'users/' + foundUid), { role: 'admin' });
  alert('Promoted to admin');
  await renderAdmins();
});

document.getElementById('demoteBtn').addEventListener('click', async ()=>{
  const email = document.getElementById('adminEmailInput').value.trim();
  if(!email){ alert('Enter email'); return; }
  const role = await getRoleForCurrentUser(); if(role !== 'owner'){ alert('Only owner can demote admins'); return; }
  const usersSnap = await get(ref(db, 'users'));
  let foundUid = null;
  usersSnap.forEach(c => { if(c.val().email === email) foundUid = c.key; });
  if(!foundUid){ alert('User not found'); return; }
  await update(ref(db, 'users/' + foundUid), { role: 'user' });
  alert('Demoted to user');
  await renderAdmins();
});

async function renderAdmins(){
  const cont = document.getElementById('adminsList'); cont.innerHTML = '';
  const role = await getRoleForCurrentUser(); if(role !== 'owner'){ cont.innerHTML = '<div class="muted">Only owner can view admin list</div>'; return; }
  const usersSnap = await get(ref(db, 'users'));
  usersSnap.forEach(c => {
    const u = c.val(); const uid = c.key;
    if(u.role === 'admin' || u.role === 'owner'){
      const row = document.createElement('div'); row.className='admin-row fade-in';
      row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
      row.innerHTML = `<div>${esc(u.email)} <span class="small-muted">(${u.role})</span></div>`;
      const actions = document.createElement('div');
      if(u.role === 'admin'){
        const dem = document.createElement('button'); dem.className='small-btn'; dem.textContent='Make user';
        dem.onclick = async ()=>{ if(confirm('Demote this admin?')){ await update(ref(db,'users/'+uid),{ role:'user' }); renderAdmins(); } };
        actions.appendChild(dem);
      } else {
        const info = document.createElement('span'); info.className='small-muted'; info.textContent='Owner';
        actions.appendChild(info);
      }
      row.appendChild(actions);
      cont.appendChild(row);
    }
  });
}

/* ----------------- Render everything after auth changes ----------------- */
async function renderAll(){
  await renderVideos();
  await renderPosts();
  await renderPositives();
  await renderGrowth();
  await renderAdmins();
  await renderComplaints(); // Admin view
  await renderUserComplaints(); // User view
  await renderContact(); // Render contact/socials
  await renderAbout(); // ADDED: Render about content
}

/* initial load helpers */
document.addEventListener('visibilitychange', ()=> { /* placeholder if needed */ });

/* initial show/hide */
document.getElementById('app').style.display = 'none';

/* End of module */
</script>
</body>
</html>

